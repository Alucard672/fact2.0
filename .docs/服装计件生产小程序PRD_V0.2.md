# 服装计件工资与生产流转小程序 PRD（V0.2）

更新时间：2025-08-21
负责人：你/我（联合）

## 1. 背景与目标
- 以微信小程序贯穿“裁床建单 → 分包打印菲票(QR) → 工人扫码领工 → 管理端扫码收包 → 自动计件 → 统计/结算”。
- 核心诉求：
  - 支持“平均裁”与“按高/低层去裁（分层段裁）”。
  - 菲票带二维码流转，防错包/重扫；计件工资自动核算；看板化统计。

## 2. 用户与角色
- 管理端：维护资料、建单分包、打印、收包、价格与结算、统计。
- 工人端：扫码领工/返修/交回、查看在制与计件统计。
- 财务端：审核计件清单、锁账、导出与发放。
- 外发伙伴（可选）：外发接收/归还与对账。

## 3. 范围（MVP）
- 组织/员工/工序/工价维护。
- 裁床建单与分包、蓝牙打印菲票（58/80mm）。
- 扫码领工与扫码收包；返修闭环。
- 自定义工序价格与优先级；自动计件与结算（周/月）。
- 首页与统计看板、车间排名；导出Excel/CSV。

## 4. 关键业务流程
1) 裁床建单
- 选择款号/颜色/尺码比例、床次、总层数L、裁剪方式：
  - 平均裁：整床同一比例R。
  - 分层段裁（高/低层或高/中/低层）：定义分段（层起-层止）与段内尺码比例（可沿用R或调整）。
- 设置分包规则：每包件数、单码/混码、余数处理。
- 系统生成“包清单（包号、尺码、件数、层段信息）”。

2) 菲票打印
- 模板字段：公司/车间、款号、颜色、尺码、床次、包号、件数、日期、二维码、工艺注意事项、【层段/层位】（分层段裁时必显）。
- 蓝牙打印；支持补打与日志。

3) 工人端扫码领工
- 包状态=待领工方可；成功后状态=在制；可设在制上限；支持撤销（未开工且有权限）。

4) 管理端扫码收包
- 必填合格/次品；可触发返修（返修重新进入待领工并保留关联）。

5) 自动计件与结算
- 按“员工×工序×合格数量×工价”计算；允许加/扣项；结算单审核→锁账→导出。

6) 统计与看板
- 维度：今日/昨日/本月/上月/今年；模块：裁剪、工序、整件、送货、车间排名；支持按层段过滤（分层段裁）。

## 5. 关键规则：平均裁 vs 按高/低层去裁
### 5.1 配置与校验
- 裁剪方式：单选【平均裁】或【按层段去裁】。
- 分段方案：2段（高/低）/3段（高/中/低）/自定义；逐段填写“层起-层止”，系统校验不重叠不漏层。
- 段内尺码比例：默认继承R，可调整；系统做“总量守恒”校验。

### 5.2 生成与打印
- 包生成：按“层段×尺码×件数”分包，余包自动标记“余包”。
- 菲票打印：分层段模板显示“层段标签（HIGH/MID/LOW）+ 层位范围（如1-10层）”。
- 二维码编码：BDL-{orgId}-{cutId}-{bundleId}-{segTag}-{checksum}。

### 5.3 扫码与统计
- 流程同MVP，包详情/记录页显示层段；统计报表支持“层段”维度的产量/良率/返修率对比。

## 6. 功能需求明细（摘要）
- 基础资料：
  - 员工（工号/姓名/车间/状态）、工序（编码/名称/单位/默认价）、工价模板（款+工序+车间、有效期/版本）。
  - 款式/尺码/颜色、客户、工艺附件。
- 裁床建单：单号、L层、R比例、分段方案、分包规则、包清单预览与导入模板。
- 打印：模板管理、批量打印、补打、日志。
- 领工/收包：扫码校验、防重复、在制上限、返修闭环、异常提示。
- 计件与结算：优先级=“款+工序+车间”>“款+工序”>“工序默认”；结算单锁账与解锁审批；导出。
- 统计与看板：首页模块与统计页、车间排名、按层段过滤。

## 7. 数据模型（简表）
- Organization(orgId), Workshop(workshopId, orgId)
- Employee(empId, code, name, phone, role, workshopId, status)
- Process(procId, code, name, unit, defaultPrice)
- ProcessPrice(priceId, styleId, procId, workshopId?, price, effectiveFrom, effectiveTo, version)
- Style(styleId, code, name, customerId, sizeSpec)
- CutOrder(cutId, styleId, color, bedNo, layers, ratioJson, segmentPlanJson, ruleJson)
- Bundle(bundleId, cutId, bundleCode, size, qty, status, layerFrom?, layerTo?, segmentTag?, qrcode, printedAt)
- BundleFlow(flowId, bundleId, action, byEmp/byUser, qtyOk, qtyNg, time, remark)
- PieceworkRecord(recordId, empId, bundleId, procId, qtyOk, unitPrice, amount, periodId?, status)
- PayrollPeriod(periodId, orgId, fromDate, toDate, status, totalAmount)
- Shipment(shipId, styleId, qty, date, customerId)
- Repair(repairId, bundleId, reason, qty, status)
- AuditLog(auditId, entity, entityId, action, before, after, operator, time)

## 8. 计算与策略
- 工价优先级：款+工序+车间 > 款+工序 > 工序默认。
- 计件入账：收包成功即生成PieceworkRecord（建议，便于实时统计）。
- 返修计价：可配置（不计价/系数0~1/固定价）。
- 加扣项：结算单维度支持奖励/扣款/借支冲抵。
- 锁账：锁定后禁止改动，解锁需审批并记录审计日志。

## 9. 非功能性
- 性能：扫码响应≤500ms；打印100张≤2分钟。
- 可靠：扫码幂等；离线队列补传（工人端）。
- 安全：微信登录/手机号绑定；按org隔离；敏感操作二次确认与日志。
- 兼容：小程序基础库≥2.25；蓝牙58/80mm常见型号。

## 10. 里程碑与验收
- 里程碑：
  1) 资料与权限；2) 裁床/分包/打印；3) 领工/收包/计件；4) 看板统计；5) 结算导出与锁账。
- 验收：
  - 1000包流转错误率<0.2%；
  - 统计/导出准确率≥99.9%；
  - 打印成功率≥99%，断连可补打。

## 11. 开放项（待确认）
- 分段常用是2段还是3段？是否允许自定义任意分段？
- 段内比例是否经常调整？是否需要“模板化保存方案”？
- 包装是否以单码包为主？混码包是否启用？余包是否需要显著标识？
- 返修是否计价及口径？
- 结算周期（周/半月/月）与工资表模板格式？
- 优先适配的蓝牙打印机型号清单？