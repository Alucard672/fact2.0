# 服装生产管理系统 - 多租户架构设计方案

## 1. 租户管理整体架构

### 1.1 核心概念
- **租户(Tenant)**: 一个服装工厂或生产企业
- **租户管理员**: 租户的创建者和主管理员
- **员工**: 被邀请加入租户的工作人员
- **数据隔离**: 确保不同租户间数据完全隔离

### 1.2 租户生命周期
```
手机号注册 → 创建租户 → 完善企业信息 → 邀请员工 → 开始使用
```

## 2. 数据库设计

### 2.1 租户表 (tenants)
```sql
CREATE TABLE `tenants` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '租户ID',
  `tenant_code` varchar(20) UNIQUE NOT NULL COMMENT '租户编码',
  `company_name` varchar(100) NOT NULL COMMENT '企业名称',
  `company_type` enum('factory','workshop','trading') DEFAULT 'factory' COMMENT '企业类型',
  `contact_person` varchar(50) NOT NULL COMMENT '联系人',
  `contact_phone` varchar(20) NOT NULL COMMENT '联系电话',
  `contact_email` varchar(100) DEFAULT NULL COMMENT '联系邮箱',
  `address` varchar(200) DEFAULT NULL COMMENT '企业地址',
  `business_license` varchar(50) DEFAULT NULL COMMENT '营业执照号',
  `tax_number` varchar(50) DEFAULT NULL COMMENT '税号',
  `logo_url` varchar(255) DEFAULT NULL COMMENT '企业Logo',
  `subscription_plan` enum('trial','basic','standard','premium') DEFAULT 'trial' COMMENT '订阅套餐',
  `subscription_start` date DEFAULT NULL COMMENT '订阅开始日期',
  `subscription_end` date DEFAULT NULL COMMENT '订阅结束日期',
  `max_users` int(11) DEFAULT 10 COMMENT '最大用户数',
  `max_storage` bigint(20) DEFAULT 1073741824 COMMENT '最大存储空间(字节)',
  `status` enum('pending','active','suspended','expired') DEFAULT 'pending' COMMENT '状态',
  `created_by` int(11) NOT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_code` (`tenant_code`),
  KEY `idx_status` (`status`),
  KEY `idx_subscription_plan` (`subscription_plan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户表';
```

### 2.2 租户用户表 (tenant_users)
```sql
CREATE TABLE `tenant_users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `tenant_id` int(11) NOT NULL COMMENT '租户ID',
  `user_id` int(11) NOT NULL COMMENT '用户ID',
  `role` enum('owner','admin','manager','supervisor','worker') NOT NULL COMMENT '租户内角色',
  `department` varchar(50) DEFAULT NULL COMMENT '部门',
  `position` varchar(50) DEFAULT NULL COMMENT '职位',
  `permissions` json DEFAULT NULL COMMENT '权限配置',
  `status` enum('pending','active','suspended') DEFAULT 'pending' COMMENT '状态',
  `invited_by` int(11) DEFAULT NULL COMMENT '邀请人ID',
  `invited_at` datetime DEFAULT NULL COMMENT '邀请时间',
  `joined_at` datetime DEFAULT NULL COMMENT '加入时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_user` (`tenant_id`, `user_id`),
  KEY `idx_role` (`role`),
  KEY `idx_status` (`status`),
  FOREIGN KEY (`tenant_id`) REFERENCES `tenants` (`id`),
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户用户关联表';
```

### 2.3 邀请记录表 (invitations)
```sql
CREATE TABLE `invitations` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `tenant_id` int(11) NOT NULL COMMENT '租户ID',
  `inviter_id` int(11) NOT NULL COMMENT '邀请人ID',
  `phone` varchar(20) NOT NULL COMMENT '被邀请人手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '被邀请人邮箱',
  `role` enum('admin','manager','supervisor','worker') NOT NULL COMMENT '邀请角色',
  `department` varchar(50) DEFAULT NULL COMMENT '部门',
  `position` varchar(50) DEFAULT NULL COMMENT '职位',
  `invitation_code` varchar(32) NOT NULL COMMENT '邀请码',
  `message` text DEFAULT NULL COMMENT '邀请消息',
  `status` enum('pending','accepted','rejected','expired') DEFAULT 'pending' COMMENT '状态',
  `expires_at` datetime NOT NULL COMMENT '过期时间',
  `accepted_at` datetime DEFAULT NULL COMMENT '接受时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_invitation_code` (`invitation_code`),
  KEY `idx_tenant_phone` (`tenant_id`, `phone`),
  KEY `idx_status` (`status`),
  FOREIGN KEY (`tenant_id`) REFERENCES `tenants` (`id`),
  FOREIGN KEY (`inviter_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='邀请记录表';
```

### 2.4 修改现有用户表
```sql
-- 在users表中添加租户相关字段
ALTER TABLE `users` ADD COLUMN `current_tenant_id` int(11) DEFAULT NULL COMMENT '当前选择的租户ID';
ALTER TABLE `users` ADD COLUMN `is_system_admin` tinyint(1) DEFAULT 0 COMMENT '是否系统管理员';
ALTER TABLE `users` ADD INDEX `idx_current_tenant` (`current_tenant_id`);
```

## 3. 注册流程设计

### 3.1 租户注册流程
```
1. 手机号验证码注册
   ↓
2. 创建用户账号
   ↓
3. 填写企业基本信息
   ↓
4. 创建租户记录
   ↓
5. 设置为租户管理员
   ↓
6. 选择订阅套餐
   ↓
7. 完成注册，进入系统
```

### 3.2 员工邀请流程
```
1. 租户管理员发起邀请
   ↓
2. 填写员工信息(手机号、角色、部门等)
   ↓
3. 生成邀请码和邀请链接
   ↓
4. 发送短信邀请
   ↓
5. 员工点击链接注册/登录
   ↓
6. 确认加入租户
   ↓
7. 完成员工添加
```

## 4. API接口设计

### 4.1 租户注册相关接口
```
POST /api/auth/register-tenant     # 租户注册
POST /api/auth/verify-phone        # 手机验证码验证
POST /api/tenants                  # 创建租户
GET  /api/tenants/current          # 获取当前租户信息
PUT  /api/tenants/current          # 更新租户信息
```

### 4.2 员工邀请相关接口
```
POST /api/invitations              # 发送邀请
GET  /api/invitations              # 获取邀请列表
PUT  /api/invitations/{id}/resend  # 重发邀请
DEL  /api/invitations/{id}         # 取消邀请
POST /api/invitations/accept       # 接受邀请
POST /api/invitations/reject       # 拒绝邀请
```

### 4.3 租户管理相关接口
```
GET  /api/tenant-users             # 获取租户用户列表
PUT  /api/tenant-users/{id}        # 更新用户角色权限
DEL  /api/tenant-users/{id}        # 移除用户
POST /api/tenant/switch            # 切换租户(用户属于多个租户时)
```

## 5. 数据隔离策略

### 5.1 行级数据隔离
- 所有业务表添加 `tenant_id` 字段
- 所有查询自动添加租户过滤条件
- 使用中间件确保数据隔离

### 5.2 需要添加tenant_id的表
```sql
-- 为现有业务表添加租户ID
ALTER TABLE `styles` ADD COLUMN `tenant_id` int(11) NOT NULL;
ALTER TABLE `processes` ADD COLUMN `tenant_id` int(11) NOT NULL;
ALTER TABLE `cut_orders` ADD COLUMN `tenant_id` int(11) NOT NULL;
ALTER TABLE `bundles` ADD COLUMN `tenant_id` int(11) NOT NULL;
ALTER TABLE `workflows` ADD COLUMN `tenant_id` int(11) NOT NULL;
ALTER TABLE `print_tasks` ADD COLUMN `tenant_id` int(11) NOT NULL;
-- ... 其他业务表

-- 添加索引
ALTER TABLE `styles` ADD INDEX `idx_tenant_id` (`tenant_id`);
ALTER TABLE `processes` ADD INDEX `idx_tenant_id` (`tenant_id`);
-- ... 其他表的索引
```

## 6. 权限管理设计

### 6.1 角色权限矩阵
| 功能模块 | Owner | Admin | Manager | Supervisor | Worker |
|---------|-------|-------|---------|------------|--------|
| 租户管理 | ✓ | ✓ | ✗ | ✗ | ✗ |
| 员工邀请 | ✓ | ✓ | ✓ | ✗ | ✗ |
| 款式管理 | ✓ | ✓ | ✓ | ✓ | ✗ |
| 裁床建单 | ✓ | ✓ | ✓ | ✓ | ✗ |
| 扫码操作 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 统计查看 | ✓ | ✓ | ✓ | ✓ | 个人 |
| 结算管理 | ✓ | ✓ | ✓ | ✗ | ✗ |

### 6.2 权限检查中间件
```php
class TenantMiddleware {
    public function handle($request, $next) {
        $user = Auth::user();
        $tenantId = $request->header('X-Tenant-ID') ?? $user->current_tenant_id;
        
        // 验证用户是否属于该租户
        if (!$this->userBelongsToTenant($user->id, $tenantId)) {
            return response()->json(['error' => 'Unauthorized'], 403);
        }
        
        // 设置当前租户上下文
        app()->instance('current_tenant_id', $tenantId);
        
        return $next($request);
    }
}
```

## 7. 订阅套餐设计

### 7.1 套餐对比
| 功能特性 | 试用版 | 基础版 | 标准版 | 高级版 |
|---------|--------|--------|--------|--------|
| 用户数量 | 5人 | 20人 | 50人 | 无限制 |
| 存储空间 | 1GB | 10GB | 50GB | 200GB |
| 数据保留 | 30天 | 1年 | 3年 | 永久 |
| 技术支持 | 无 | 邮件 | 电话+邮件 | 专属客服 |
| 高级功能 | ✗ | 部分 | ✓ | ✓ |
| 价格/月 | 免费 | ¥299 | ¥899 | ¥1999 |

### 7.2 功能限制检查
```php
class SubscriptionService {
    public function checkUserLimit($tenantId) {
        $tenant = Tenant::find($tenantId);
        $currentUsers = TenantUser::where('tenant_id', $tenantId)
            ->where('status', 'active')->count();
        
        return $currentUsers < $tenant->max_users;
    }
    
    public function checkStorageLimit($tenantId, $fileSize) {
        $tenant = Tenant::find($tenantId);
        $currentUsage = $this->getCurrentStorageUsage($tenantId);
        
        return ($currentUsage + $fileSize) <= $tenant->max_storage;
    }
}
```

## 8. 小程序端实现

### 8.1 注册页面流程
```javascript
// 租户注册流程
const registerTenant = {
  // 步骤1: 手机验证
  phoneVerification: {
    phone: '',
    verifyCode: '',
    countdown: 0
  },
  
  // 步骤2: 企业信息
  companyInfo: {
    companyName: '',
    companyType: 'factory',
    contactPerson: '',
    address: ''
  },
  
  // 步骤3: 套餐选择
  subscription: {
    plan: 'trial',
    duration: 1
  }
};
```

### 8.2 邀请功能实现
```javascript
// 员工邀请
const inviteEmployee = {
  phone: '',
  role: 'worker',
  department: '',
  position: '',
  message: ''
};

// 发送邀请
const sendInvitation = async (inviteData) => {
  const response = await api.post('/invitations', inviteData);
  if (response.success) {
    wx.showToast({
      title: '邀请已发送',
      icon: 'success'
    });
  }
};
```

## 9. 安全考虑

### 9.1 数据安全
- 所有API请求必须包含租户标识
- 严格的权限验证和数据隔离
- 敏感操作需要二次验证
- 定期数据备份和恢复机制

### 9.2 邀请安全
- 邀请码有效期限制(7天)
- 邀请码只能使用一次
- 手机号验证确保身份真实性
- 邀请记录完整审计日志

## 10. 实施计划

### Phase 1: 基础架构(1周)
- 数据库表结构设计和创建
- 基础API接口开发
- 数据隔离中间件实现

### Phase 2: 注册流程(1周)
- 租户注册页面开发
- 手机验证码功能
- 企业信息完善流程

### Phase 3: 邀请功能(1周)
- 员工邀请功能开发
- 邀请接受流程
- 权限管理完善

### Phase 4: 订阅管理(1周)
- 套餐管理功能
- 功能限制检查
- 支付集成(可选)

这个多租户架构设计确保了数据安全、功能完整，同时为商业化运营提供了坚实的技术基础。